const NBA_ANSWERS = [
  {
    "name": "Quentin Grimes",
    "colleges": [
      "University of Kansas",
      "University of Houston"
    ],
    "playerId": "1629656"
  },
  {
    "name": "Royce O'Neale",
    "colleges": [
      "University of Denver",
      "Baylor University"
    ],
    "playerId": "1626220"
  },
  {
    "name": "Brandon Clarke",
    "colleges": [
      "San Jose State University",
      "Gonzaga University"
    ],
    "playerId": "1629634"
  },
  {
    "name": "Keon Ellis",
    "colleges": [
      "University of Alabama"
    ],
    "playerId": "1631165"
  },
  {
    "name": "Jamal Murray",
    "colleges": [
      "University of Kentucky"
    ],
    "playerId": "1627750"
  },
  {
    "name": "Jordan Poole",
    "colleges": [
      "University of Michigan"
    ],
    "playerId": "1629673"
  },
  {
    "name": "Jonathan Isaac",
    "colleges": [
      "Florida State University"
    ],
    "playerId": "1628371"
  },
  {
    "name": "Gary Payton II",
    "colleges": [
      "Oregon State University"
    ],
    "playerId": "1627780"
  },
  {
    "name": "Kelly Oubre Jr.",
    "colleges": [
      "University of Kansas"
    ],
    "playerId": "1626162"
  },
  {
    "name": "Onyeka Okongwu",
    "colleges": [
      "University of Southern California"
    ],
    "playerId": "1630168"
  },
  {
    "name": "Trey Murphy III",
    "colleges": [
      "Rice University",
      "University of Virginia"
    ],
    "playerId": "1630530"
  },
  {
    "name": "Darius Garland",
    "colleges": [
      "Vanderbilt University"
    ],
    "playerId": "1629636"
  },
  {
    "name": "Jarrett Allen",
    "colleges": [
      "University of Texas - Austin"
    ],
    "playerId": "1628386"
  },
  {
    "name": "Jrue Holiday",
    "colleges": [
      "University of California - Los Angeles - UCLA"
    ],
    "playerId": "201950"
  },
  {
    "name": "Anthony Black",
    "colleges": [
      "University of Arkansas"
    ],
    "playerId": "1641710"
  },
  {
    "name": "Cameron Johnson",
    "colleges": [
      "University of Pittsburgh",
      "University of North Carolina at Chapel Hill",
    ],
    "playerId": "1629661"
  },
  {
    "name": "Santi Aldama",
    "colleges": [
      "Loyola University Maryland"
    ],
    "playerId": "1630583"
  },
  {
    "name": "Kyle Kuzma",
    "colleges": [
      "University of Utah"
    ],
    "playerId": "1628398"
  },
  {
    "name": "T.J. McConnell",
    "colleges": [
      "Duquesne University",
      "University of Arizona"
    ],
    "playerId": "204456"
  }
];

const WNBA_ANSWERS = [
  {
    "name": "Kelsey Mitchell",
    "colleges": [
      "Ohio State University"
    ],
    "playerId": "1628909"
  },
  {
    "name": "Alyssa Thomas",
    "colleges": [
      "University of Maryland"
    ],
    "playerId": "203826"
  },
  {
    "name": "Skylar Diggins-Smith",
    "colleges": [
      "University of Notre Dame"
    ],
    "playerId": "203400"
  },
  {
    "name": "Maddy Siegrist",
    "colleges": [
      "Villanova University"
    ],
    "playerId": "1641652"
  },
  {
    "name": "Ariel Atkins",
    "colleges": [
      "University of Texas - Austin"
    ],
    "playerId": "1628878"
  },
  {
    "name": "Satou Sabally",
    "colleges": [
      "University of Oregon"
    ],
    "playerId": "1630149"
  },
  {
    "name": "Alysha Clark",
    "colleges": [
      "Middle Tennessee State University",
      "Belmont University"
    ],
    "playerId": "202252"
  },
  {
    "name": "Emily Engstler",
    "colleges": [
      "Syracuse University",
      "University of Louisville"
    ],
    "playerId": "1631083"
  },
  {
    "name": "Stefanie Dolson",
    "colleges": [
      "University of Connecticut"
    ],
    "playerId": "203828"
  },
  {
    "name": "Kamilla Cardoso",
    "colleges": [
      "Syracuse University",
      "University of South Carolina"
    ],
    "playerId": "1642289"
  },
  {
    "name": "Kelsey Plum",
    "colleges": [
      "University of Washington"
    ],
    "playerId": "1628276"
  },
  {
    "name": "Lexie Brown",
    "colleges": [
      "University of Maryland",
      "Duke University"
    ],
    "playerId": "1628882"
  },
  {
    "name": "Alanna Smith",
    "colleges": [
      "Stanford University"
    ],
    "playerId": "1629501"
  },
  {
    "name": "Diamond DeShields",
    "colleges": [
      "University of North Carolina at Chapel Hill",
      "University of Tennessee"
    ],
    "playerId": "1628890"
  },
  {
    "name": "Jonquel Jones",
    "colleges": [
      "Clemson University",
      "George Washington University"
    ],
    "playerId": "1627673"
  },
  {
    "name": "Courtney Vandersloot",
    "colleges": [
      "Gonzaga University"
    ],
    "playerId": "202664"
  },
  {
    "name": "Natasha Howard",
    "colleges": [
      "Florida State University"
    ],
    "playerId": "203827"
  },
  {
    "name": "Queen Egbo",
    "colleges": [
      "Baylor University"
    ],
    "playerId": "1631031"
  },
  {
    "name": "Betnijah Laney-Hamilton",
    "colleges": [
      "Rutgers University"
    ],
    "playerId": "204335"
  }
];

const COLLEGES = [
  "Abilene Christian University",
  "Alabama A&M University",
  "Alabama State University",
  "Alcorn State University",
  "American University",
  "Appalachian State University",
  "Arizona State University",
  "Arkansas State University",
  "Auburn University",
  "Austin Peay State University",
  "Ball State University",
  "Baylor University",
  "Bellarmine University",
  "Belmont University",
  "Bethune-Cookman University",
  "Boise State University",
  "Boston College",
  "Boston University",
  "Bowling Green State University",
  "Bradley University",
  "Brigham Young University",
  "Brown University",
  "Bryant University",
  "Bucknell University",
  "Butler University",
  "California Baptist University",
  "California Polytechnic State University - San Luis Obispo",
  "California State University - Bakersfield",
  "California State University - Fresno",
  "California State University - Fullerton",
  "California State University - Long Beach",
  "California State University - Northridge",
  "California State University - Sacramento",
  "Campbell University",
  "Canisius College",
  "Central Connecticut State University",
  "Central Michigan University",
  "Charleston Southern University",
  "Chicago State University",
  "Clemson University",
  "Cleveland State University",
  "Coastal Carolina University",
  "Colgate University",
  "College of Charleston",
  "College of the Holy Cross",
  "Colorado State University",
  "Columbia University",
  "Coppin State University",
  "Cornell University",
  "Creighton University",
  "Dartmouth College",
  "Davidson College",
  "Delaware State University",
  "DePaul University",
  "Drake University",
  "Drexel University",
  "Duke University",
  "Duquesne University",
  "East Carolina University",
  "East Tennessee State University",
  "Eastern Illinois University",
  "Eastern Kentucky University",
  "Eastern Michigan University",
  "Eastern Washington University",
  "Elon University",
  "Fairfield University",
  "Fairleigh Dickinson University",
  "Florida A&M University",
  "Florida Atlantic University",
  "Florida Gulf Coast University",
  "Florida International University",
  "Florida State University",
  "Fordham University",
  "Furman University",
  "Gardner-Webb University",
  "George Mason University",
  "George Washington University",
  "Georgetown University",
  "Georgia Southern University",
  "Georgia State University",
  "Georgia Tech",
  "Gonzaga University",
  "Grambling State University",
  "Grand Canyon University",
  "Hamline University",
  "Hampton University",
  "Harvard University",
  "High Point University",
  "Hofstra University",
  "Houston Christian University",
  "Howard University",
  "Idaho State University",
  "Illinois State University",
  "Indiana State University",
  "Indiana University",
  "Indiana University-Purdue University - Indianapolis (IUPUI)",
  "Iona University",
  "Iowa State University",
  "Jackson State University",
  "Jacksonville State University",
  "Jacksonville University",
  "James Madison University",
  "Kansas State University",
  "Kennesaw State University",
  "Kent State University",
  "La Salle University",
  "Lafayette College",
  "Lamar University",
  "Lehigh University",
  "Liberty University",
  "Lindenwood University",
  "Lipscomb University",
  "Long Island University",
  "Longwood University",
  "Louisiana State University (LSU)",
  "Louisiana Tech University",
  "Loyola Marymount University",
  "Loyola University Chicago",
  "Loyola University Maryland",
  "Manhattan College",
  "Marist College",
  "Marquette University",
  "Marshall University",
  "McNeese State University",
  "Mercer University",
  "Merrimack College",
  "Miami University",
  "Michigan State University",
  "Middle Tennessee State University",
  "Mississippi State University",
  "Mississippi Valley State University",
  "Missouri State University",
  "Monmouth University",
  "Montana State University",
  "Morehead State University",
  "Morgan State University",
  "Mount St. Mary's University",
  "Murray State University",
  "New Jersey Institute of Technology",
  "New Mexico State University",
  "Niagara University",
  "Nicholls State University",
  "Norfolk State University",
  "North Carolina A&T State University",
  "North Carolina Central University",
  "North Carolina State University",
  "North Dakota State University",
  "Northeastern University",
  "Northern Arizona University",
  "Northern Illinois University",
  "Northern Kentucky University",
  "Northwestern State University of Louisiana",
  "Northwestern University",
  "Oakland University",
  "Ohio State University",
  "Ohio University",
  "Oklahoma State University",
  "Old Dominion University",
  "Oral Roberts University",
  "Oregon State University",
  "Penn State",
  "Pepperdine University",
  "Portland State University",
  "Prairie View A & M University",
  "Presbyterian College",
  "Princeton University",
  "Providence College",
  "Purdue University",
  "Purdue University - Fort Wayne",
  "Queens University of Charlotte",
  "Quinnipiac University",
  "Radford University",
  "Rice University",
  "Rider University",
  "Robert Morris University - Pennsylvania",
  "Rutgers University",
  "Sacred Heart University",
  "Saint Francis University",
  "Saint Joseph's University",
  "Saint Louis University",
  "Saint Mary's College of California",
  "Saint Peter's University",
  "Sam Houston State University",
  "Samford University",
  "San Diego State University",
  "San Jose State University",
  "Santa Clara University",
  "Seattle University",
  "Seton Hall University",
  "Siena College",
  "South Carolina State University",
  "South Dakota State University",
  "Southeast Missouri State University",
  "Southeastern Louisiana University",
  "Southern Illinois University Carbondale",
  "Southern Illinois University Edwardsville",
  "Southern Methodist University - SMU",
  "Southern University & A&M College",
  "Southern Utah University",
  "St. Bonaventure University",
  "St. Francis College",
  "St. John's University - New York",
  "Stanford University",
  "Stephen F Austin State University",
  "Stetson University",
  "Stonehill College",
  "SUNY Binghamton University",
  "SUNY Stony Brook University",
  "SUNY University at Albany",
  "SUNY University at Buffalo",
  "Syracuse University",
  "Tarleton State University",
  "Temple University",
  "Tennessee State University",
  "Texas A&M University",
  "Texas A&M University - Commerce",
  "Texas A&M University - Corpus Christi",
  "Texas Christian University",
  "Texas Southern University",
  "Texas State University",
  "Texas Tech University",
  "The Citadel",
  "Towson University",
  "Troy University",
  "Tulane University",
  "United States Air Force Academy",
  "United States Military Academy",
  "United States Naval Academy",
  "University of Akron",
  "University of Alabama",
  "University of Alabama - Birmingham",
  "University of Arizona",
  "University of Arkansas",
  "University of Arkansas at Little Rock",
  "University of Arkansas at Pine Bluff",
  "University of California - Berkeley",
  "University of California - Davis",
  "University of California - Irvine",
  "University of California - Los Angeles - UCLA",
  "University of California - Riverside",
  "University of California - San Diego",
  "University of California - Santa Barbara",
  "University of Central Arkansas",
  "University of Central Florida",
  "University of Central Florida",
  "University of Cincinnati",
  "University of Colorado - Boulder",
  "University of Connecticut",
  "University of Dayton",
  "University of Delaware",
  "University of Denver",
  "University of Detroit Mercy",
  "University of Evansville",
  "University of Florida",
  "University of Georgia",
  "University of Hawaii at Manoa",
  "University of Houston",
  "University of Idaho",
  "University of Illinois",
  "University of Illinois at Chicago",
  "University of Iowa",
  "University of Kansas",
  "University of Kentucky",
  "University of Louisiana",
  "University of Louisiana - Monroe",
  "University of Louisville",
  "University of Maine",
  "University of Maryland",
  "University of Maryland - Baltimore County",
  "University of Maryland Eastern Shore",
  "University of Massachusetts - Amherst",
  "University of Massachusetts - Lowell",
  "University of Memphis",
  "University of Miami",
  "University of Michigan",
  "University of Minnesota",
  "University of Mississippi",
  "University of Missouri",
  "University of Missouri - Kansas City",
  "University of Montana",
  "University of Nebraska",
  "University of Nebraska at Omaha",
  "University of Nevada - Las Vegas",
  "University of Nevada - Reno",
  "University of New Hampshire",
  "University of New Mexico",
  "University of New Orleans",
  "University of North Alabama",
  "University of North Carolina - Greensboro",
  "University of North Carolina - Wilmington",
  "University of North Carolina Asheville",
  "University of North Carolina at Chapel Hill",
  "University of North Carolina at Charlotte",
  "University of North Dakota",
  "University of North Florida",
  "University of North Texas",
  "University of Northern Colorado",
  "University of Northern Iowa",
  "University of Notre Dame",
  "University of Oklahoma",
  "University of Oregon",
  "University of Pennsylvania - Penn",
  "University of Pittsburgh",
  "University of Portland",
  "University of Rhode Island",
  "University of Richmond",
  "University of San Diego",
  "University of San Francisco",
  "University of South Alabama",
  "University of South Carolina",
  "University of South Carolina - Upstate",
  "University of South Dakota",
  "University of South Florida",
  "University of Southern California",
  "University of Southern Mississippi",
  "University of St. Thomas - Minnesota",
  "University of Tennessee",
  "University of Tennessee - Chattanooga",
  "University of Tennessee - Martin",
  "University of Texas - Arlington",
  "University of Texas - Austin",
  "University of Texas - El Paso",
  "University of Texas - Rio Grande Valley",
  "University of Texas - San Antonio",
  "University of the Incarnate Word",
  "University of the Pacific",
  "University of Toledo",
  "University of Tulsa",
  "University of Utah",
  "University of Vermont",
  "University of Virginia",
  "University of Washington",
  "University of Wisconsin",
  "University of Wisconsin - Green Bay",
  "University of Wisconsin - Milwaukee",
  "University of Wyoming",
  "Utah State University",
  "Utah Tech University (Formerly Dixie State University)",
  "Utah Valley University",
  "Valparaiso University",
  "Vanderbilt University",
  "Villanova University",
  "Virginia Commonwealth University",
  "Virginia Military Institute - VMI",
  "Virginia Tech",
  "Wagner College",
  "Wake Forest University",
  "Washington State University",
  "Weber State University",
  "West Virginia University",
  "Western Carolina University",
  "Western Illinois University",
  "Western Kentucky University",
  "Western Michigan University",
  "Wichita State University",
  "William & Mary",
  "Winthrop University",
  "Wofford College",
  "Wright State University",
  "Xavier University",
  "Yale University",
  "Youngstown State University"
];

const now = new Date();
const TWENTY_FOUR_HOURS_IN_MILLIS = 86400000;
const RELEASE_DAY = new Date("2025-03-20");
const MIN_GUESSES = 3;

const BLACK_SQUARE = String.fromCodePoint(0x2B1B);
const GREEN_SQUARE = String.fromCodePoint(0x1F7E9);
const RED_SQUARE = String.fromCodePoint(0x1F7E5);

const gameIndexFromQueryParams = new URL(window.location.toString()).searchParams?.get("g");
const gameIndex = gameIndexFromQueryParams ? parseInt(gameIndexFromQueryParams, 10) : Math.floor((now - RELEASE_DAY) / TWENTY_FOUR_HOURS_IN_MILLIS);
const gameNumber = gameIndex + 1;
const todayKey = `WTG-1-${gameNumber}`;
const todaysAnswers = [
  {
    league: "NBA",
    headshot: `https://cdn.nba.com/headshots/nba/latest/260x190/${NBA_ANSWERS[gameIndex]?.playerId}.png`,
    ...NBA_ANSWERS[gameIndex],
  },
  {
    league: "WNBA",
    headshot: `https://cdn.wnba.com/headshots/wnba/latest/260x190/${WNBA_ANSWERS[gameIndex]?.playerId}.png`,
    ...WNBA_ANSWERS[gameIndex],
  },
];

const getLeagueLogo = (league) => `./images/${league.toLowerCase()}-logo.png`;

const tokenizeCollege = (college, tokens = []) => {
  const trimmedCollege = college.trim();
  const spaceIndex = trimmedCollege.indexOf(" ");
  const newTokens = [...tokens, trimmedCollege];

  if (spaceIndex >= 0) {
    const rest = trimmedCollege.substring(spaceIndex + 1);
    return tokenizeCollege(rest, newTokens);
  }

  return newTokens;
}

const getMaxGuesses = (colleges) => MIN_GUESSES + 2 * (colleges.length - 1);

const isRoundCorrect = (colleges, guesses) => colleges.every((c) => guesses.includes(c))

const isRoundFinished = (colleges, guesses) => {
  const maxGuesses = getMaxGuesses(colleges);
  return isRoundCorrect(colleges, guesses) || guesses.length === maxGuesses;
};

const renderGuesses = (colleges, guesses) => {
  const maxGuesses = getMaxGuesses(colleges);

  return [...Array(maxGuesses)].map((_, guessIndex) => {
    const hasGuess = !!guesses[guessIndex];
    const guess = guesses[guessIndex];
    const isCorrect = colleges.includes(guess);

    const guessText = guess || `Guess ${guessIndex + 1}`
    const classes = Object.entries({
      correct: hasGuess && isCorrect,
      incorrect: hasGuess && !isCorrect,
    }).reduce((acc, [k, v]) => v ? `${acc} ${k}` : acc, "");

    return `<div class="row guess ${classes}">${guessText}</div>`;
  }).join("");
};

const renderPlayerSection = ({ name, headshot, colleges, league, roundIndex, guesses }) => {
  const numCorrectGuesses = new Set(colleges).intersection(new Set(guesses)).size;

  return `
    <div class="player">
      <div class="round__player">
        <img
          class="round__player__headshot"
          src="${headshot}"
          alt="${name}"
        />
        <h2 class="round__player__name">${name}</h2>
      </div>
      <div class="round__found">${numCorrectGuesses}/${colleges.length} schools found</div>
      <div class="round__guesses">
        <div class="round__guesses__column">
          <div class="round__guesses__input">
            <input
              type="text"
              id="college-input-${roundIndex}"
              placeholder="NCAA school"
              ${isRoundFinished(colleges, guesses) ? "disabled" : ""}
            />
            <ol class="autosuggest" id="autosuggest-list-${roundIndex}"></ol>
          </div>
          ${renderGuesses(colleges, guesses)}
        </div>
      </div>
    </div>
  `;
};

const renderResultEmoji = (guesses, roundIndex) => {
  const colleges = todaysAnswers[roundIndex].colleges
  const maxGuesses = getMaxGuesses(colleges);

  return [...Array(maxGuesses)].map(
    (_, i) => {
      if (guesses.length <= i) {
        return BLACK_SQUARE;
      }

      if (colleges.includes(guesses[i])) {
        return GREEN_SQUARE;
      }

      return RED_SQUARE;
    }
  ).join("");
};

const renderResultModal = (todaysResults) => {
  const resultEmojiHTML = todaysResults.map((guesses, roundIndex) => {
    const leagueName = todaysAnswers[roundIndex].league.toLowerCase();
    return `
      <div class="league-results">
        <img src="${getLeagueLogo(leagueName)}" />
        <span>${renderResultEmoji(guesses, roundIndex)}</span>
      </div>
    `;
  }).join("");
  const resultEmojiText = `Where'd they go? Game Day #${gameNumber}\n` +
    todaysResults.map((guesses, roundIndex) => renderResultEmoji(guesses, roundIndex)).join("\n") +
    "\n";

  const winner = todaysResults.every(
    (guesses, roundIndex) => isRoundCorrect(todaysAnswers[roundIndex].colleges, guesses)
  );
  const partialWinner = todaysResults.some(
    (guesses, roundIndex) => isRoundCorrect(todaysAnswers[roundIndex].colleges, guesses)
  );

  let header = "AIR BALLLLLL";
  if (winner) {
    header = "<i>SWISHHHH</i>";
  } else if (partialWinner) {
    header = "1 for 2 ain't that bad";
  }

  const onCopy = () => {
    navigator.clipboard.writeText(resultEmojiText).then(() => {
    const copied = document.querySelector(".copied-popup");
    copied.style["opacity"] = "1";

    setTimeout(() => {
      copied.style["opacity"] = "0";
    }, 1500);
  });
  }

  const resultsModal = document.createElement("div");
  resultsModal.className = "results-modal";
  resultsModal.innerHTML = `
    <button id="close-results">&#x2715;</button>
    <h3 class="header">${header}</h3>
    <p>Let's run it back tomorrow</p>
    <div class="result-emoji">
      ${resultEmojiHTML}
    </div>
    <button id="copy-results">Copy Results</button>
  `;
  const body = document.querySelector("body");
  body.append(resultsModal);

  const copyButton = document.querySelector("#copy-results");
  copyButton.onclick = onCopy;

  const closeButton = document.querySelector("#close-results");
  closeButton.onclick = () => resultsModal.remove();
};

const updateResults = () => {
  const todaysResults = JSON.parse(window.localStorage.getItem(todayKey) || "[[],[]]");

  const gameZone = document.getElementById("game-zone");

  const setupEventListeners = (roundIndex) => {
    const collegeInput = document.getElementById(`college-input-${roundIndex}`);
    const autosuggestList = document.getElementById(`autosuggest-list-${roundIndex}`);

    collegeInput.addEventListener("input", (inputEvent) => {
      const inputValue = inputEvent.target.value;
      const suggestions = COLLEGES.filter(
        (college) => tokenizeCollege(college).some(
          (collegePart) =>
            inputValue.trim().length > 0 &&
              collegePart.toLowerCase().startsWith(inputValue.trim().toLowerCase())
        )
      );

      if (suggestions.length > 0) {
        autosuggestList.innerHTML = suggestions.map(
          (suggestion) => `<li class="college">${suggestion}</li>`
        ).join("");

        Array.from(autosuggestList.getElementsByClassName("college")).map(
          (collegeElement) => collegeElement.addEventListener(
            "click",
            (clickEvent) => {
              const newResults = todaysResults.map((guesses, i) => {
                const colleges = todaysAnswers[i].colleges;
                const maxGuesses = getMaxGuesses(colleges);

                if (roundIndex === i) {
                  return [...guesses, collegeElement.innerText];
                }

                return guesses;
              });
              window.localStorage.setItem(todayKey, JSON.stringify(newResults));
              updateResults();
            }
          )
        );
      } else {
        autosuggestList.innerHTML = "";
      }
    });
  };

  if (gameNumber > NBA_ANSWERS.length) {
    gameZone.innerHTML = `<h2 class="next-year">We'll see you in March</h2>`;
  } else {
    gameZone.innerHTML = `<h3 class="game-number">Game Day #${gameNumber}</h3>` + todaysResults.map((guesses, roundIndex) => {
      return renderPlayerSection({ ...todaysAnswers[roundIndex], guesses, roundIndex });
    }).join("<hr />");

    let todaysGameComplete = true;

    todaysResults.forEach((guesses, roundIndex) => {
      setupEventListeners(roundIndex);

      if (!isRoundFinished(todaysAnswers[roundIndex].colleges, guesses)) {
        todaysGameComplete = false;
      }
    });

    if (todaysGameComplete) {
      renderResultModal(todaysResults);
    }
  }
};

window.addEventListener("load", function () {
  updateResults();
})
